[ { "name": "Mathieu", "percent": 65, "fixed": 0, "appliesTo": "total" }, {
"name": "Sacha", "percent": 35, "fixed": 0, "appliesTo": "total" }, { "name":
"Malt", "percent": 10, "fixed": 0, "appliesTo": "deposit" } ]

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Autobuilders Commissions</title>
    <style>
      :root {
        color-scheme: light dark;
      }

      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #0b1120;
        color: #e2e8f0;
        padding: 16px;
        min-height: 100vh;
      }

      main {
        max-width: 700px;
        margin: 0 auto;
        text-align: center;
        padding: 24px;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.88);
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.3);
      }

      h1 {
        margin: 0 0 12px;
        font-size: 20px;
      }

      p {
        margin: 6px 0;
      }

      .deal-id {
        margin-top: 16px;
        font-size: 18px;
        font-weight: 600;
      }

      .deal-name {
        margin-top: 4px;
        font-size: 16px;
        font-weight: 500;
      }

      .source-hint {
        margin-top: 6px;
        font-size: 13px;
        color: rgba(226, 232, 240, 0.7);
      }

      .error {
        color: #f87171;
      }

      .tips {
        font-size: 13px;
        margin-top: 12px;
        color: rgba(226, 232, 240, 0.75);
      }

      .field-block {
        margin-top: 20px;
        text-align: left;
      }

      .field-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 6px;
      }

      pre.field-value {
        background: rgba(15, 23, 42, 0.55);
        border-radius: 8px;
        padding: 12px;
        font-size: 13px;
        line-height: 1.4;
        white-space: pre-wrap;
        word-break: break-word;
        margin: 0;
      }

      pre.field-value.empty {
        font-style: italic;
        opacity: 0.7;
      }

      .data-grid {
        margin-top: 20px;
        display: grid;
        gap: 16px;
      }

      .data-item {
        background: rgba(15, 23, 42, 0.55);
        border-radius: 8px;
        padding: 12px;
        text-align: left;
      }

      .data-item-label {
        font-size: 13px;
        font-weight: 600;
        color: rgba(226, 232, 240, 0.8);
        margin-bottom: 6px;
      }

      .data-item-value {
        font-size: 15px;
        color: #e2e8f0;
        font-weight: 500;
      }

      .data-item-value.config {
        font-size: 12px;
        font-family: monospace;
        white-space: pre-wrap;
        word-break: break-word;
        line-height: 1.4;
      }

      .summary-section {
        margin-top: 24px;
        text-align: left;
      }

      .summary-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 12px;
        color: #38bdf8;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 24px;
      }

      .summary-card {
        background: rgba(56, 189, 248, 0.1);
        border: 1px solid rgba(56, 189, 248, 0.3);
        border-radius: 8px;
        padding: 12px;
      }

      .summary-card-label {
        font-size: 12px;
        font-weight: 600;
        color: rgba(226, 232, 240, 0.7);
        margin-bottom: 4px;
      }

      .summary-card-value {
        font-size: 20px;
        font-weight: 700;
        color: #38bdf8;
      }

      .commission-list {
        margin-top: 16px;
      }

      .commission-item {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(226, 232, 240, 0.1);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
      }

      .commission-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(226, 232, 240, 0.1);
      }

      .commission-name {
        font-size: 16px;
        font-weight: 700;
        color: #e2e8f0;
      }

      .commission-total {
        font-size: 18px;
        font-weight: 700;
        color: #34d399;
      }

      .commission-badge {
        display: inline-block;
        font-size: 11px;
        font-weight: 600;
        padding: 3px 8px;
        border-radius: 4px;
        margin-left: 8px;
        background: rgba(168, 85, 247, 0.2);
        color: #c084fc;
      }

      .commission-badge.deposit {
        background: rgba(251, 191, 36, 0.2);
        color: #fbbf24;
      }

      .commission-details {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-top: 8px;
      }

      .commission-detail {
        font-size: 13px;
        color: rgba(226, 232, 240, 0.8);
      }

      .commission-detail-label {
        font-weight: 600;
        color: rgba(226, 232, 240, 0.6);
        display: block;
        margin-bottom: 2px;
      }

      .commission-detail-value {
        font-weight: 500;
        color: #e2e8f0;
      }

      .verification-section {
        margin-top: 24px;
        padding: 16px;
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        border-radius: 8px;
        text-align: center;
      }

      .verification-section.error {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.3);
      }

      .verification-label {
        font-size: 13px;
        font-weight: 600;
        color: rgba(226, 232, 240, 0.7);
        margin-bottom: 4px;
      }

      .verification-value {
        font-size: 16px;
        font-weight: 700;
        color: #34d399;
      }

      .verification-section.error .verification-value {
        color: #ef4444;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@pipedrive/app-extensions-sdk@0/dist/index.umd.js"></script>
  </head>
  <body>
    <main id="root">
      <h1>Loading commissions panelâ€¦</h1>
      <p>Connecting to Pipedrive SDK.</p>
    </main>
    <script>
      (function () {
        const COMMISSION_FIELD_KEY = "1a514f40d36407ecd675c76cc539481989400ac6";
        const DEPOSIT_PERCENT_FIELD_KEY =
          "315e79ee4cf37b98a64b73194f3f32da234278ba";
        const COMMISSION_FIELD_NAME = "commission_config_json";
        const root = document.getElementById("root");
        const queryParams = new URLSearchParams(window.location.search);

        function getDealIdFromQuery() {
          const params = queryParams;

          function pickFirstSelectedId() {
            const rawValues = [];

            if (params.has("selectedIds")) {
              rawValues.push(params.get("selectedIds"));
            }

            if (params.has("selected_ids")) {
              rawValues.push(params.get("selected_ids"));
            }

            params.getAll("selectedIds").forEach((value) => {
              if (!rawValues.includes(value)) {
                rawValues.push(value);
              }
            });

            params.getAll("selected_ids").forEach((value) => {
              if (!rawValues.includes(value)) {
                rawValues.push(value);
              }
            });

            for (const candidate of rawValues) {
              if (!candidate) {
                continue;
              }

              const parts = String(candidate)
                .split(",")
                .map((item) => item.trim())
                .filter(Boolean);

              if (parts.length) {
                return parts[0];
              }
            }

            return null;
          }

          const selectedId = pickFirstSelectedId();
          if (selectedId) {
            return selectedId;
          }

          return (
            params.get("dealId") ||
            params.get("deal_id") ||
            params.get("itemId") ||
            params.get("id") ||
            null
          );
        }

        function normalizeName(value) {
          if (value === null || value === undefined) {
            return null;
          }

          const trimmed = String(value).trim();
          return trimmed.length ? trimmed : null;
        }

        function getDealNameFromQuery() {
          const params = queryParams;
          const keys = [
            "dealTitle",
            "deal_title",
            "dealName",
            "deal_name",
            "title",
            "name",
          ];

          for (const key of keys) {
            if (!params.has(key)) {
              continue;
            }

            const candidate = normalizeName(params.get(key));
            if (candidate) {
              return candidate;
            }
          }

          return null;
        }

        function extractDealName(context) {
          if (!context || typeof context !== "object") {
            return null;
          }

          const contextsToCheck = [context];

          if (context.context && typeof context.context === "object") {
            contextsToCheck.push(context.context);
          }

          if (context.data && typeof context.data === "object") {
            contextsToCheck.push(context.data);
          }

          const nameCandidates = [];

          function pushName(value) {
            const candidate = normalizeName(value);
            if (candidate && !nameCandidates.includes(candidate)) {
              nameCandidates.push(candidate);
            }
          }

          function collect(candidateContext) {
            if (!candidateContext || typeof candidateContext !== "object") {
              return;
            }

            pushName(candidateContext.dealTitle);
            pushName(candidateContext.deal_name);
            pushName(candidateContext.dealName);
            pushName(candidateContext.title);
            pushName(candidateContext.name);

            if (
              candidateContext.deal &&
              typeof candidateContext.deal === "object"
            ) {
              pushName(candidateContext.deal.title);
              pushName(candidateContext.deal.name);
            }

            if (
              candidateContext.currentDeal &&
              typeof candidateContext.currentDeal === "object"
            ) {
              pushName(candidateContext.currentDeal.title);
              pushName(candidateContext.currentDeal.name);
            }

            if (
              candidateContext.entity &&
              typeof candidateContext.entity === "object"
            ) {
              pushName(candidateContext.entity.title);
              pushName(candidateContext.entity.name);
            }

            if (
              candidateContext.object &&
              typeof candidateContext.object === "object"
            ) {
              pushName(candidateContext.object.title);
              pushName(candidateContext.object.name);
            }

            if (
              candidateContext.item &&
              typeof candidateContext.item === "object"
            ) {
              pushName(candidateContext.item.title);
              pushName(candidateContext.item.name);
            }

            if (Array.isArray(candidateContext.selectedItems)) {
              candidateContext.selectedItems.forEach((item) => {
                if (item && typeof item === "object") {
                  pushName(item.title);
                  pushName(item.name);
                }
              });
            }

            if (Array.isArray(candidateContext.items)) {
              candidateContext.items.forEach((item) => {
                if (item && typeof item === "object") {
                  pushName(item.title);
                  pushName(item.name);
                }
              });
            }
          }

          contextsToCheck.forEach(collect);

          if (nameCandidates.length) {
            return nameCandidates[0];
          }

          return null;
        }

        function coerceId(value) {
          if (value === null || value === undefined) {
            return null;
          }
          const trimmed = String(value).trim();
          return trimmed.length ? trimmed : null;
        }

        function escapeHtml(value) {
          return String(value ?? "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        function extractDealId(context) {
          if (!context || typeof context !== "object") {
            return null;
          }

          const contextsToCheck = [context];

          if (context.context && typeof context.context === "object") {
            contextsToCheck.push(context.context);
          }

          if (context.data && typeof context.data === "object") {
            contextsToCheck.push(context.data);
          }

          const candidates = [];

          function pushCandidate(value) {
            const coerced = coerceId(value);
            if (coerced && !candidates.includes(coerced)) {
              candidates.push(coerced);
            }
          }

          function collectFromCandidate(candidateContext) {
            if (!candidateContext || typeof candidateContext !== "object") {
              return;
            }

            pushCandidate(candidateContext.dealId);
            pushCandidate(candidateContext.deal_id);

            if (
              candidateContext.deal &&
              typeof candidateContext.deal === "object"
            ) {
              pushCandidate(candidateContext.deal.id);
              pushCandidate(candidateContext.deal.dealId);
              pushCandidate(candidateContext.deal.deal_id);
            }

            if (
              candidateContext.currentDeal &&
              typeof candidateContext.currentDeal === "object"
            ) {
              pushCandidate(candidateContext.currentDeal.id);
            }

            if (
              candidateContext.object &&
              typeof candidateContext.object === "object"
            ) {
              const object = candidateContext.object;
              pushCandidate(object.dealId);
              if (
                object.type === "deal" ||
                object.object === "deal" ||
                object.entity === "deal" ||
                object.entity_type === "deal"
              ) {
                pushCandidate(object.id);
              }
            }

            if (
              candidateContext.item &&
              typeof candidateContext.item === "object"
            ) {
              const item = candidateContext.item;
              pushCandidate(item.dealId);
              if (!item.type || item.type === "deal") {
                pushCandidate(item.id);
              }
            }

            if (
              candidateContext.entity &&
              typeof candidateContext.entity === "object"
            ) {
              const entity = candidateContext.entity;
              if (entity.type === "deal" || entity.entity === "deal") {
                pushCandidate(entity.id);
              }
            }

            if (Array.isArray(candidateContext.selectedIds)) {
              candidateContext.selectedIds.forEach(pushCandidate);
            }

            if (Array.isArray(candidateContext.items)) {
              candidateContext.items.forEach((item) => {
                if (item && typeof item === "object") {
                  pushCandidate(item.dealId);
                  if (!item.type || item.type === "deal") {
                    pushCandidate(item.id);
                  }
                }
              });
            }

            if (Array.isArray(candidateContext.selectedItems)) {
              candidateContext.selectedItems.forEach((item) => {
                if (item && typeof item === "object") {
                  pushCandidate(item.dealId);
                  if (!item.type || item.type === "deal") {
                    pushCandidate(item.id);
                  }
                }
              });
            }
          }

          contextsToCheck.forEach(collectFromCandidate);

          const numericCandidate = candidates.find((value) =>
            /^\d+$/.test(value)
          );
          if (numericCandidate) {
            return numericCandidate;
          }

          for (const candidate of candidates) {
            if (candidate) {
              return candidate;
            }
          }

          return null;
        }

        function isTraversableCandidate(value) {
          if (!value || typeof value !== "object") {
            return false;
          }

          const tag = Object.prototype.toString.call(value);
          return tag === "[object Object]" || tag === "[object Array]";
        }

        function extractCustomField(context, fieldKey) {
          if (!context || typeof context !== "object") {
            return { value: null, source: null };
          }

          const visited = new WeakSet();
          const queue = [];
          const MAX_STEPS = 400;
          let steps = 0;

          function enqueue(candidate, label) {
            if (!isTraversableCandidate(candidate)) {
              return;
            }
            if (visited.has(candidate)) {
              return;
            }
            queue.push({ node: candidate, label });
          }

          enqueue(context, "sdk.initialize context");
          enqueue(context.context, "context.context");
          enqueue(context.data, "context.data");
          enqueue(context.deal, "context.deal");
          enqueue(context.object, "context.object");
          enqueue(context.item, "context.item");
          enqueue(context.currentDeal, "context.currentDeal");

          if (Array.isArray(context.selectedItems)) {
            context.selectedItems.forEach((item, index) => {
              enqueue(item, `context.selectedItems[${index}]`);
            });
          }

          while (queue.length && steps < MAX_STEPS) {
            const { node, label } = queue.shift();
            if (!isTraversableCandidate(node)) {
              continue;
            }

            if (visited.has(node)) {
              continue;
            }

            visited.add(node);
            steps += 1;

            let hasField = false;
            try {
              hasField = Object.prototype.hasOwnProperty.call(node, fieldKey);
            } catch (error) {
              hasField = false;
            }

            if (hasField) {
              let fieldValue = null;
              try {
                fieldValue = node[fieldKey];
              } catch (error) {
                fieldValue = null;
              }
              return { value: fieldValue, source: label };
            }

            let values;
            try {
              values = Array.isArray(node) ? node : Object.values(node);
            } catch (error) {
              continue;
            }
            values.forEach((value) => {
              if (value && typeof value === "object" && !visited.has(value)) {
                enqueue(value, label);
              }
            });
          }

          return { value: null, source: null };
        }

        function formatFieldValue(value) {
          if (value === null || value === undefined || value === "") {
            return { text: "Not set", isPlaceholder: true };
          }

          if (typeof value === "object") {
            try {
              return {
                text: JSON.stringify(value, null, 2),
                isPlaceholder: false,
              };
            } catch (error) {
              return {
                text: "[Unable to serialize value]",
                isPlaceholder: true,
              };
            }
          }

          const raw = String(value);
          const trimmed = raw.trim();

          if (!trimmed) {
            return { text: "Not set", isPlaceholder: true };
          }

          try {
            const parsed = JSON.parse(trimmed);
            return {
              text: JSON.stringify(parsed, null, 2),
              isPlaceholder: false,
            };
          } catch (error) {
            return { text: raw, isPlaceholder: false };
          }
        }

        function calculateCommissions(
          commissionConfig,
          dealValue,
          depositPercent
        ) {
          const originalDepositAmount = (dealValue * depositPercent) / 100;
          const originalRemainingAmount = dealValue - originalDepositAmount;

          // First pass: calculate fixed amounts and deposit-only commissions
          let totalFixedAmounts = 0;
          let totalDepositOnlyCommissions = 0;

          commissionConfig.forEach((config) => {
            totalFixedAmounts += config.fixed || 0;

            if (config.appliesTo === "deposit") {
              const depositCommission =
                (originalDepositAmount * config.percent) / 100;
              totalDepositOnlyCommissions += depositCommission;
            }
          });

          // Calculate the adjusted base for "total" commissions
          // Deal value minus fixed amounts minus deposit-only commissions
          const adjustedBaseForTotal =
            dealValue - totalFixedAmounts - totalDepositOnlyCommissions;
          const adjustedDepositForTotal =
            originalDepositAmount - totalDepositOnlyCommissions;
          const adjustedRemainingForTotal =
            adjustedBaseForTotal - adjustedDepositForTotal;

          // Second pass: calculate actual commissions
          const commissions = commissionConfig.map((config) => {
            const fixedAmount = config.fixed || 0;
            let percentAmount = 0;
            let onDeposit = 0;
            let onRemaining = 0;

            if (config.appliesTo === "deposit") {
              // Deposit-only: calculate on original deposit amount
              percentAmount = (originalDepositAmount * config.percent) / 100;
              onDeposit = percentAmount;
              onRemaining = 0;
            } else {
              // Total: calculate on adjusted base (excluding fixed and deposit-only)
              percentAmount = (adjustedBaseForTotal * config.percent) / 100;
              onDeposit = (adjustedDepositForTotal * config.percent) / 100;
              onRemaining = (adjustedRemainingForTotal * config.percent) / 100;
            }

            const total = percentAmount + fixedAmount;

            return {
              name: config.name,
              percent: config.percent,
              fixed: fixedAmount,
              appliesTo: config.appliesTo || "total",
              depositAmount: onDeposit,
              remainingAmount: onRemaining,
              total: total,
            };
          });

          const totalCommissions = commissions.reduce(
            (sum, c) => sum + c.total,
            0
          );

          return {
            commissions,
            dealValue,
            depositAmount: originalDepositAmount,
            remainingAmount: originalRemainingAmount,
            totalCommissions,
            isValid: Math.abs(totalCommissions - dealValue) < 0.01,
          };
        }

        function formatCurrency(value) {
          if (value === null || value === undefined || isNaN(value)) {
            return "â‚¬0";
          }
          return `â‚¬${value.toLocaleString("fr-FR", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          })}`;
        }

        function showResult(result) {
          const dealNameLabel = result.dealName
            ? escapeHtml(result.dealName)
            : "Unknown deal";

          // Parse commission config
          let commissionConfig = [];
          if (result.commissionConfig) {
            try {
              commissionConfig =
                typeof result.commissionConfig === "string"
                  ? JSON.parse(result.commissionConfig)
                  : result.commissionConfig;

              if (!Array.isArray(commissionConfig)) {
                commissionConfig = [];
              }
            } catch (e) {
              console.error("Failed to parse commission config:", e);
              commissionConfig = [];
            }
          }

          const dealValue = result.dealValue || 0;
          const depositPercent = result.depositPercent || 0;

          // Calculate commissions
          const calculations = calculateCommissions(
            commissionConfig,
            dealValue,
            depositPercent
          );

          // Generate commission items HTML
          const commissionsHTML = calculations.commissions
            .map((commission) => {
              const badge =
                commission.appliesTo === "deposit"
                  ? '<span class="commission-badge deposit">Deposit Only</span>'
                  : '<span class="commission-badge">Total</span>';

              const fixedDisplay =
                commission.fixed > 0
                  ? `<div class="commission-detail">
                   <span class="commission-detail-label">Fixed Amount</span>
                   <span class="commission-detail-value">${formatCurrency(
                     commission.fixed
                   )}</span>
                 </div>`
                  : "";

              return `
              <div class="commission-item">
                <div class="commission-header">
                  <div>
                    <span class="commission-name">${escapeHtml(
                      commission.name
                    )}</span>
                    ${badge}
                  </div>
                  <div class="commission-total">${formatCurrency(
                    commission.total
                  )}</div>
                </div>
                <div class="commission-details">
                  <div class="commission-detail">
                    <span class="commission-detail-label">Commission %</span>
                    <span class="commission-detail-value">${
                      commission.percent
                    }%</span>
                  </div>
                  ${fixedDisplay}
                  <div class="commission-detail">
                    <span class="commission-detail-label">On Deposit</span>
                    <span class="commission-detail-value">${formatCurrency(
                      commission.depositAmount
                    )}</span>
                  </div>
                  <div class="commission-detail">
                    <span class="commission-detail-label">On Remaining</span>
                    <span class="commission-detail-value">${formatCurrency(
                      commission.remainingAmount
                    )}</span>
                  </div>
                </div>
              </div>
            `;
            })
            .join("");

          const verificationClass = calculations.isValid ? "" : " error";
          const verificationMessage = calculations.isValid
            ? "âœ“ Commissions equal deal value"
            : "âš  Commissions do not match deal value";

          root.innerHTML = `
            <h1>ðŸ’° Commission Breakdown</h1>
            <p class="deal-name">${dealNameLabel}</p>
            
            <div class="summary-section">
              <div class="summary-grid">
                <div class="summary-card">
                  <div class="summary-card-label">Deal Value</div>
                  <div class="summary-card-value">${formatCurrency(
                    calculations.dealValue
                  )}</div>
                </div>
                <div class="summary-card">
                  <div class="summary-card-label">Deposit (${depositPercent}%)</div>
                  <div class="summary-card-value">${formatCurrency(
                    calculations.depositAmount
                  )}</div>
                </div>
                <div class="summary-card">
                  <div class="summary-card-label">Remaining</div>
                  <div class="summary-card-value">${formatCurrency(
                    calculations.remainingAmount
                  )}</div>
                </div>
                <div class="summary-card">
                  <div class="summary-card-label">Total Commissions</div>
                  <div class="summary-card-value">${formatCurrency(
                    calculations.totalCommissions
                  )}</div>
                </div>
              </div>

              <div class="summary-title">Commission Distribution</div>
              <div class="commission-list">
                ${
                  commissionsHTML ||
                  '<p style="text-align:center;color:rgba(226, 232, 240, 0.6);">No commission configuration found</p>'
                }
              </div>

              <div class="verification-section${verificationClass}">
                <div class="verification-label">Verification</div>
                <div class="verification-value">${verificationMessage}</div>
              </div>
            </div>
          `;
        }

        function showError(message) {
          root.innerHTML = `
            <h1 class="error">Unable to load commissions</h1>
            <p>${escapeHtml(message)}</p>
            <p class="tips">Confirm this iframe is rendered inside a Deal panel.</p>
          `;
        }

        function showAuthRequired(authUrl) {
          const authorizeUrl = escapeHtml(authUrl || "/auth/pipedrive");

          root.innerHTML = `
            <h1>Connect Autobuilders Commissions</h1>
            <p>We need permission to read and update the commission configuration on this deal.</p>
            <p class="tips">Open the authorization flow, grant access, then reload this panel.</p>
            <p>
              <a
                href="${authorizeUrl}"
                target="_blank"
                rel="noreferrer"
                style="display:inline-flex;align-items:center;justify-content:center;padding:10px 16px;margin-top:12px;border-radius:8px;background:#38bdf8;color:#0f172a;font-weight:600;text-decoration:none;"
              >Authorize app</a>
            </p>
          `;
        }

        async function fetchCommissionSummary(dealId) {
          const response = await fetch(
            `/api/deals/${encodeURIComponent(dealId)}/commission`,
            {
              headers: {
                Accept: "application/json",
              },
            }
          );

          const payload = await response.json().catch(() => ({}));

          console.log("=== API Response Debug ===");
          console.log("Response status:", response.status);
          console.log("Response OK:", response.ok);
          console.log("Full payload from API:", payload);
          console.log("payload.summary:", payload.summary);
          console.log("payload.deal:", payload.deal);
          console.log("=========================");

          if (!response.ok) {
            const error = new Error(
              payload.error ||
                `Failed to load commission configuration (HTTP ${response.status})`
            );
            error.status = response.status;
            error.payload = payload;
            error.authUrl =
              payload.loginUrl || payload.authorizeUrl || "/auth/pipedrive";
            throw error;
          }

          return payload;
        }

        async function renderDealFromApi(
          dealId,
          detectionSource,
          fallbackField,
          fallbackFieldSource,
          fallbackDealName
        ) {
          try {
            const payload = await fetchCommissionSummary(dealId);
            const dealName =
              payload?.deal?.title ||
              payload?.deal?.name ||
              fallbackDealName ||
              null;

            // Extract the three key fields from payload.deal
            const commissionConfig =
              payload?.deal?.[COMMISSION_FIELD_KEY] || null;
            const depositPercent =
              payload?.deal?.[DEPOSIT_PERCENT_FIELD_KEY] || null;
            const dealValue = payload?.deal?.value || null;

            showResult({
              dealId,
              source: detectionSource,
              dealName,
              commissionConfig,
              depositPercent,
              dealValue,
            });
          } catch (error) {
            console.error("Failed to fetch commission summary", error);

            if (error.status === 401) {
              showAuthRequired(error.authUrl);
              return;
            }

            if (fallbackField !== null && fallbackField !== undefined) {
              showResult({
                dealId,
                source: detectionSource,
                fieldValue: fallbackField,
                fieldSource: fallbackFieldSource,
                dealName: fallbackDealName,
              });
              return;
            }

            showError(error.message || "Unable to load commission data");
          }
        }

        async function initialize() {
          const fallbackId = coerceId(getDealIdFromQuery());
          const fallbackName = getDealNameFromQuery();

          if (!window.AppExtensionsSDK) {
            if (fallbackId) {
              showResult({
                dealId: fallbackId,
                source: "query string",
                fieldValue: null,
                fieldSource: null,
                dealName: fallbackName,
              });
              return;
            }
            showError("Pipedrive SDK is not available.");
            return;
          }

          const sdk = new window.AppExtensionsSDK();
          let context = null;

          try {
            const initResult = await sdk.initialize();
            if (initResult && typeof initResult === "object") {
              context = initResult.context || initResult.data || initResult;
            }
          } catch (error) {
            console.warn("Pipedrive SDK initialize failed", error);
          }

          if (!context && typeof sdk.getContext === "function") {
            try {
              context = await sdk.getContext();
            } catch (error) {
              console.warn("sdk.getContext() failed", error);
            }
          }

          if (!context && sdk.context && typeof sdk.context === "object") {
            context = sdk.context;
          }

          const dealIdFromContext = coerceId(extractDealId(context));
          const dealId = dealIdFromContext || fallbackId;
          const { value: fieldValue, source: fieldSource } = extractCustomField(
            context,
            COMMISSION_FIELD_KEY
          );
          const dealNameFromContext = extractDealName(context);
          const dealName = dealNameFromContext || fallbackName || null;

          if (dealId) {
            await renderDealFromApi(
              dealId,
              dealIdFromContext ? "Pipedrive context" : "query string",
              fieldValue,
              fieldSource,
              dealName
            );
            return;
          }

          showError("No deal ID found in SDK context or query parameters.");
        }

        initialize();
      })();
    </script>
  </body>
</html>
