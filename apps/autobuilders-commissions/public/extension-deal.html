<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Autobuilders Commissions</title>
    <style>
      :root {
        color-scheme: light dark;
      }

      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #0b1120;
        color: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
      }

      main {
        text-align: center;
        padding: 24px;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.88);
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.3);
        width: min(360px, 90vw);
      }

      h1 {
        margin: 0 0 12px;
        font-size: 20px;
      }

      p {
        margin: 6px 0;
      }

      .deal-id {
        margin-top: 16px;
        font-size: 18px;
        font-weight: 600;
      }

      .source-hint {
        margin-top: 6px;
        font-size: 13px;
        color: rgba(226, 232, 240, 0.7);
      }

      .error {
        color: #f87171;
      }

      .tips {
        font-size: 13px;
        margin-top: 12px;
        color: rgba(226, 232, 240, 0.75);
      }

      .field-block {
        margin-top: 20px;
        text-align: left;
      }

      .field-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 6px;
      }

      pre.field-value {
        background: rgba(15, 23, 42, 0.55);
        border-radius: 8px;
        padding: 12px;
        font-size: 13px;
        line-height: 1.4;
        white-space: pre-wrap;
        word-break: break-word;
        margin: 0;
      }

      pre.field-value.empty {
        font-style: italic;
        opacity: 0.7;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@pipedrive/app-extensions-sdk@0/dist/index.umd.js"></script>
  </head>
  <body>
    <main id="root">
      <h1>Loading commissions panelâ€¦</h1>
      <p>Connecting to Pipedrive SDK.</p>
    </main>
    <script>
      (function () {
        const COMMISSION_FIELD_KEY = "1a514f40d36407ecd675c76cc539481989400ac6";
        const COMMISSION_FIELD_NAME = "commission_config_json";
        const root = document.getElementById("root");

        function getDealIdFromQuery() {
          const params = new URLSearchParams(window.location.search);
          return (
            params.get("dealId") ||
            params.get("deal_id") ||
            params.get("itemId") ||
            params.get("id") ||
            null
          );
        }

        function coerceId(value) {
          if (value === null || value === undefined) {
            return null;
          }
          const trimmed = String(value).trim();
          return trimmed.length ? trimmed : null;
        }

        function escapeHtml(value) {
          return String(value ?? "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        function extractDealId(context) {
          if (!context || typeof context !== "object") {
            return null;
          }

          const contextsToCheck = [context];

          if (context.context && typeof context.context === "object") {
            contextsToCheck.push(context.context);
          }

          if (context.data && typeof context.data === "object") {
            contextsToCheck.push(context.data);
          }

          const candidates = [];

          function pushCandidate(value) {
            const coerced = coerceId(value);
            if (coerced && !candidates.includes(coerced)) {
              candidates.push(coerced);
            }
          }

          function collectFromCandidate(candidateContext) {
            if (!candidateContext || typeof candidateContext !== "object") {
              return;
            }

            pushCandidate(candidateContext.dealId);
            pushCandidate(candidateContext.deal_id);

            if (
              candidateContext.deal &&
              typeof candidateContext.deal === "object"
            ) {
              pushCandidate(candidateContext.deal.id);
              pushCandidate(candidateContext.deal.dealId);
              pushCandidate(candidateContext.deal.deal_id);
            }

            if (
              candidateContext.currentDeal &&
              typeof candidateContext.currentDeal === "object"
            ) {
              pushCandidate(candidateContext.currentDeal.id);
            }

            if (
              candidateContext.object &&
              typeof candidateContext.object === "object"
            ) {
              const object = candidateContext.object;
              pushCandidate(object.dealId);
              if (
                object.type === "deal" ||
                object.object === "deal" ||
                object.entity === "deal" ||
                object.entity_type === "deal"
              ) {
                pushCandidate(object.id);
              }
            }

            if (
              candidateContext.item &&
              typeof candidateContext.item === "object"
            ) {
              const item = candidateContext.item;
              pushCandidate(item.dealId);
              if (!item.type || item.type === "deal") {
                pushCandidate(item.id);
              }
            }

            if (
              candidateContext.entity &&
              typeof candidateContext.entity === "object"
            ) {
              const entity = candidateContext.entity;
              if (entity.type === "deal" || entity.entity === "deal") {
                pushCandidate(entity.id);
              }
            }

            if (Array.isArray(candidateContext.selectedIds)) {
              candidateContext.selectedIds.forEach(pushCandidate);
            }

            if (Array.isArray(candidateContext.items)) {
              candidateContext.items.forEach((item) => {
                if (item && typeof item === "object") {
                  pushCandidate(item.dealId);
                  if (!item.type || item.type === "deal") {
                    pushCandidate(item.id);
                  }
                }
              });
            }

            if (Array.isArray(candidateContext.selectedItems)) {
              candidateContext.selectedItems.forEach((item) => {
                if (item && typeof item === "object") {
                  pushCandidate(item.dealId);
                  if (!item.type || item.type === "deal") {
                    pushCandidate(item.id);
                  }
                }
              });
            }
          }

          contextsToCheck.forEach(collectFromCandidate);

          const numericCandidate = candidates.find((value) =>
            /^\d+$/.test(value)
          );
          if (numericCandidate) {
            return numericCandidate;
          }

          for (const candidate of candidates) {
            if (candidate) {
              return candidate;
            }
          }

          return null;
        }

        function isTraversableCandidate(value) {
          if (!value || typeof value !== "object") {
            return false;
          }

          const tag = Object.prototype.toString.call(value);
          return tag === "[object Object]" || tag === "[object Array]";
        }

        function extractCustomField(context, fieldKey) {
          if (!context || typeof context !== "object") {
            return { value: null, source: null };
          }

          const visited = new WeakSet();
          const queue = [];
          const MAX_STEPS = 400;
          let steps = 0;

          function enqueue(candidate, label) {
            if (!isTraversableCandidate(candidate)) {
              return;
            }
            if (visited.has(candidate)) {
              return;
            }
            queue.push({ node: candidate, label });
          }

          enqueue(context, "sdk.initialize context");
          enqueue(context.context, "context.context");
          enqueue(context.data, "context.data");
          enqueue(context.deal, "context.deal");
          enqueue(context.object, "context.object");
          enqueue(context.item, "context.item");
          enqueue(context.currentDeal, "context.currentDeal");

          if (Array.isArray(context.selectedItems)) {
            context.selectedItems.forEach((item, index) => {
              enqueue(item, `context.selectedItems[${index}]`);
            });
          }

          while (queue.length && steps < MAX_STEPS) {
            const { node, label } = queue.shift();
            if (!isTraversableCandidate(node)) {
              continue;
            }

            if (visited.has(node)) {
              continue;
            }

            visited.add(node);
            steps += 1;

            let hasField = false;
            try {
              hasField = Object.prototype.hasOwnProperty.call(node, fieldKey);
            } catch (error) {
              hasField = false;
            }

            if (hasField) {
              let fieldValue = null;
              try {
                fieldValue = node[fieldKey];
              } catch (error) {
                fieldValue = null;
              }
              return { value: fieldValue, source: label };
            }

            let values;
            try {
              values = Array.isArray(node) ? node : Object.values(node);
            } catch (error) {
              continue;
            }
            values.forEach((value) => {
              if (value && typeof value === "object" && !visited.has(value)) {
                enqueue(value, label);
              }
            });
          }

          return { value: null, source: null };
        }

        function formatFieldValue(value) {
          if (value === null || value === undefined || value === "") {
            return { text: "Not set", isPlaceholder: true };
          }

          if (typeof value === "object") {
            try {
              return {
                text: JSON.stringify(value, null, 2),
                isPlaceholder: false,
              };
            } catch (error) {
              return {
                text: "[Unable to serialize value]",
                isPlaceholder: true,
              };
            }
          }

          const raw = String(value);
          const trimmed = raw.trim();

          if (!trimmed) {
            return { text: "Not set", isPlaceholder: true };
          }

          try {
            const parsed = JSON.parse(trimmed);
            return {
              text: JSON.stringify(parsed, null, 2),
              isPlaceholder: false,
            };
          } catch (error) {
            return { text: raw, isPlaceholder: false };
          }
        }

        function showResult(result) {
          const sourceLabel = result.source
            ? escapeHtml(result.source)
            : "unknown";
          const fieldPresentation = formatFieldValue(result.fieldValue);
          const fieldClass = fieldPresentation.isPlaceholder ? " empty" : "";
          const fieldHint = result.fieldSource
            ? `Field located via ${result.fieldSource}.`
            : "Field not present in SDK context.";
          const fieldText = escapeHtml(fieldPresentation.text);
          const fieldHintText = escapeHtml(fieldHint);

          root.innerHTML = `
            <h1>Commissions panel ready.</h1>
            <p class="deal-id">Deal ID: ${escapeHtml(result.dealId)}</p>
            <p class="source-hint">Detected via ${sourceLabel}.</p>
            <div class="field-block">
              <span class="field-label">${COMMISSION_FIELD_NAME}</span>
              <pre class="field-value${fieldClass}">${fieldText}</pre>
              <p class="source-hint">${fieldHintText}</p>
            </div>
          `;
        }

        function showError(message) {
          root.innerHTML = `
            <h1 class="error">Unable to detect deal ID</h1>
            <p>${escapeHtml(message)}</p>
            <p class="tips">Confirm this iframe is rendered inside a Deal panel.</p>
          `;
        }

        async function initialize() {
          const fallbackId = coerceId(getDealIdFromQuery());

          if (!window.AppExtensionsSDK) {
            if (fallbackId) {
              showResult({
                dealId: fallbackId,
                source: "query string",
                fieldValue: null,
                fieldSource: null,
              });
              return;
            }
            showError("Pipedrive SDK is not available.");
            return;
          }

          const sdk = new window.AppExtensionsSDK();
          let context = null;

          try {
            const initResult = await sdk.initialize();
            if (initResult && typeof initResult === "object") {
              context = initResult.context || initResult.data || initResult;
            }
          } catch (error) {
            console.warn("Pipedrive SDK initialize failed", error);
          }

          if (!context && typeof sdk.getContext === "function") {
            try {
              context = await sdk.getContext();
            } catch (error) {
              console.warn("sdk.getContext() failed", error);
            }
          }

          if (!context && sdk.context && typeof sdk.context === "object") {
            context = sdk.context;
          }

          const dealIdFromContext = coerceId(extractDealId(context));
          const dealId = dealIdFromContext || fallbackId;
          const { value: fieldValue, source: fieldSource } = extractCustomField(
            context,
            COMMISSION_FIELD_KEY
          );

          if (dealId) {
            showResult({
              dealId,
              source: dealIdFromContext ? "Pipedrive context" : "query string",
              fieldValue,
              fieldSource,
            });
            return;
          }

          showError("No deal ID found in SDK context or query parameters.");
        }

        initialize();
      })();
    </script>
  </body>
</html>
